version: "3"

environment:

processes:

  celestia-light-node:
    command: |
      exit 1

  celestia-light-node-synced:
    command: |
      cargo run --bin wait-for-celestia-light-node
    depends_on:
      celestia-light-node:
        condition: process_healthy
    availability:
      restart: exit_on_failure

  m1-da-light-node:
    command: |
      # FIXME(nix-ci-fix): when we modify LD_PATH directly, we get a missing libstdc++ here
      ./target/debug/m1-da-light-node
    depends_on:
      celestia-light-node-synced:
        condition: process_completed_successfully
    readiness_probe:
      initial_delay_seconds: 10
      exec:
        command: echo "true"
    liveness_probe:
      initial_delay_seconds: 10
      exec:
        command: echo "true"
    availability:
      restart: exit_on_failure

  monza-full-node:
    command: |
      ./target/debug/monza-full-node
    depends_on:
      m1-da-light-node:
        condition: process_healthy
    readiness_probe:
      initial_delay_seconds: 10
      exec:
        command: |
          echo "true"

  monza-faucet:
    command : |
      # FIXME(nix-ci-fix): this is the latest we can push linking issues, here and in the Monza client tests we will get a libssl linking issue
      ./scripts/monza/faucet
    depends_on:
      monza-full-node:
        condition: process_healthy
    readiness_probe:
      initial_delay_seconds: 10
      exec:
        command: echo "true"

